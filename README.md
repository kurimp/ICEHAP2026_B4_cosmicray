# Cosmic Ray Analysis Kit

このリポジトリには、宇宙線検出データ解析のためのPythonスクリプト群が含まれています。シミュレーション結果と実験測定結果を組み合わせて分析を行います。
なお、このReadme.txtはGeminiを用いて作成されました。また、内容は2025年6月16日時点の物であり、最新の内容と異なる場合があります。

## 目次

  - [概要]
  - [ファイル構造]
  - [依存関係]
  - [使用方法]
      - [シミュレーション (Cosmic_Ray_Simulation_20250609_x_flux_py.py)]
      - [実験データ処理 (ana_hist_date_250616.py)]
      - [時間変化解析 (coin_change_250615.py)]
      - [データ分析と可視化 (analyzation_250616.py)]
  - [出力ファイル]
  - [バックグラウンド減算とフラックス計算]
  - [誤差伝播]

## 概要

このキットは以下の機能を提供します：

1.  シミュレーション: 検出器の立体角や天頂角コサインの平均値など、検出器の幾何学的要因を決定するための宇宙線飛跡シミュレーション。
2.  実験データ処理: 生の実験データから時間ごとのコインシデンスレートを計算。
3.  時間変化解析: 累積平均レートの時間変化を可視化。
4.  データ分析: シミュレーション結果と実験データを組み合わせて、バックグラウンド減算と統計誤差伝播を考慮した上で、天頂角に応じた宇宙線フラックスを導出。
5.  可視化: 結果のプロット、特に実験フラックスを理論モデルにフィッティングして表示。

## ファイル構造
.
├── Cosmic_Ray_Simulation_20250609_x_flux_py.py
├── ana_hist_date_250616.py
├── analyzation_250616.py
├── coin_change_250615.py
├── CosmicRaySimulation/
│   └── CosmicRaySimulation_flux.csv  (シミュレーションスクリプトにより生成)
├── pocket_counter_output/
│   ├── datas/
│   │   └── *.txt  (入力: 生の実験データファイル)
│   ├── images/
│   │   └── *.png  (データ処理スクリプトにより生成)
│   ├── results/
│   │   └── *.csv  (データ処理スクリプトにより生成)
│   ├── changes/
│   │   └── *.png  (時間変化解析スクリプトにより生成)
│   └── BG.csv  (データ処理スクリプトにより生成)
├── analyzation_result.png (分析スクリプトにより生成)
└── Result.csv (分析スクリプトにより生成)

## 依存関係

スクリプトは以下のPythonライブラリを必要とします：
  - numpy
  - matplotlib
  - scipy
  - pandas
  - tqdm
  - natsort

以上はpipを使用してインストールできます。また、他のものを要することもありますので、必要に応じてインストールしてください。

## 使用方法

すべてのスクリプトは、カレントディレクトリが.pyファイルが配置されているディレクトリであることを前提としています(プログラムにおいて自動的にカレントディレクトリは変更されます)。生の実験データファイル（.txt）はpocket_counter_output/datas/に配置されていることを確認してください。

### シミュレーション (Cosmic_Ray_Simulation_20250609_x_flux_py.py)
このスクリプトは、様々な検出器配置（特にplate1のx位置を変化させた場合）に対する幾何学的因子を決定するために宇宙線飛跡をシミュレーションします。生成されたシミュレーション結果は、後の解析に不可欠です。
なお、シミュレーション結果はすでに出力されています。

このスクリプトは以下を実行します：

  - 2つの検出器「プレート」を通過する宇宙線の経路をシミュレーションします。
  - 2種類の宇宙線角度分布（$\\cos\\theta$に一様と$\\cos^2\\theta$に比例）について、同時計数、平均立体角、および平均天頂角コサインを計算します。
  - シミュレーション結果を視覚化する複数のプロットを生成します。
  - シミュレーション結果を./CosmicRaySimulation/CosmicRaySimulation_flux.csvに保存します。

### 実験データ処理 (ana_hist_date_250616.py)

このスクリプトは、生の宇宙線カウンターデータ（.txtファイル）を処理し、時間ごとのコインシデンスレートを計算します。また、バックグラウンド測定の総計も行います。

このスクリプトは以下を実行します：

  - ./pocket_counter_output/datas/内のすべての.txtファイルを読み込みます。
  - 各ファイルについて、30分間隔でコインシデンスレートを計算し、グラフとして./pocket_counter_output/images/に保存します。
  - ファイル名に基づいてバックグラウンド測定を識別し、すべてのバックグラウンド測定の平均レートと標準偏差を計算し、./pocket_counter_output/BG.csvに保存します。
  - 各測定の平均レートと標準偏差を含む集計結果を./pocket_counter_output/results/pocket_counter_output_YYMMDD_HHMMSS.csvに保存します。

### 時間変化解析 (coin_change_250615.py)

このスクリプトは、個々の測定データファイル（.txt）を読み込み、時間経過に伴うコインシデンスレートの累積平均の変化をプロットします。

このスクリプトは以下を実行します：

  - ./pocket_counter_output/datas/内のすべての.txtファイルを読み込みます。
  - 各ファイルについて、30分間隔でコインシデンスレートを計算し、時間経過に伴う累積平均レートとその誤差を棒グラフでプロットします。
  - 生成されたグラフは./pocket_counter_output/changes/にPNGファイルとして保存されます。

### データ分析と可視化 (analyzation_250616.py)

このスクリプトは、実験結果とシミュレーション結果を結合し、宇宙線フラックスを計算します。その後、そのフラックスを理論モデルにフィッティングし、結果をプロットします。

このスクリプトは、シミュレーションと実験データ処理が完了した後に実行します。


このスクリプトは以下を実行します：

  - 最新の実験結果CSVファイル（./pocket_counter_output/results/）とシミュレーション結果CSVファイル（./CosmicRaySimulation/）を読み込みます。
  - バックグラウンドデータ（./pocket_counter_output/BG.csv）を読み込みます。
  - 実験データにシミュレーションから得られた$\\cos\\theta$の平均と立体角の平均をマージします。
  - バックグラウンド減算と統計誤差伝播を適用して、宇宙線フラックスを計算します。
  - 計算されたフラックスが非負のデータのみを保持します。
  - フラックスを$\\cos\\theta$の関数として、2つのモデル（$a + b \\times x^n$ および $a + b \\times x^2$）にフィッティングします。
  - 測定されたフラックスとフィッティングされた曲線をプロットし、誤差棒を表示します。
  - 最終的なグラフをanalyzation_result.pngとして保存し、計算されたフラックスを含むデータフレームをResult.csvとして保存します。

## 出力ファイル

  - ./CosmicRaySimulation/CosmicRaySimulation_flux.csv: シミュレーションによって計算された、様々な検出器配置における同時計数率、平均立体角、平均天頂角コサイン、およびそれらの標準偏差を含むCSVファイル。
  - ./pocket_counter_output/images/*.png: 各実験測定の30分ごとのコインシデンスレートの棒グラフ。
  - ./pocket_counter_output/changes/*.png: 各実験測定のコインシデンスレートの累積平均の変化を示す棒グラフ。
  - ./pocket_counter_output/results/pocket_counter_output_YYMMDD_HHMMSS.csv: 全ての実験測定の集計結果を含むCSVファイル。ファイル名、測定条件、平均コインシデンスレート、およびその標準偏差が含まれます。
  - ./pocket_counter_output/BG.csv: バックグラウンド測定の総計コインシデンス数、総測定時間、平均レート、および標準偏差を含むCSVファイル。
  - analyzation_result.png: 測定された宇宙線フラックスとフィッティングされたモデル曲線を示す最終的なプロット。
  - Result.csv: 最終的な分析結果（計算されたフラックスとその誤差など）を含むCSVファイル。

## バックグラウンド減算とフラックス計算

プログラムは、以下の手順で宇宙線フラックスを計算します：

1.  バックグラウンドレートの計算: バックグラウンドとラベル付けされた測定ファイルから、バックグラウンドの総コインシデンス数と総測定時間を集計し、全体の平均バックグラウンドレート（Mean_BG）と標準偏差（Std_BG）を算出します。
2.  純粋な信号レートの計算: 各測定の平均レート（mean）からMean_BGを減算します。
3.  フラックスの導出: 純粋な信号レートをシミュレーションで得られた平均立体角（Mean_SolidAngle_CosSquaredTheta(sr)）で除算し、単位を調整します（コードでは/100されています）。

## 誤差伝播

統計誤差の伝播には、以下の関数が実装されています：

  - stat_err_01(M1, e1, M2, e2): 割り算 $M1/M2$ の誤差を計算します。
    $$\frac{M1}{M2} \pm \sqrt{\left(\frac{1}{M2}\epsilon1\right)^2 + \left(\frac{M1}{M2^2}\epsilon2\right)^2}$$
  - stat_err_02(M1, e1, M2, e2): 引き算 $M1 - M2$ の誤差を計算します。
    $$(M1 - M2) \pm \sqrt{\epsilon1^2 + \epsilon2^2}$$
  - stat_err_03(M1, e1, M2, e2, M3, e3): 複合演算 $(M1 - M2) / M3$ の誤差を計算します。これは、stat_err_02の結果をstat_err_01に渡すことで実現されます。

これらの関数は、測定値が独立であり、誤差がランダム誤差（統計誤差）であるという仮定に基づいて、標準的な誤差伝播の法則を適用しています。
